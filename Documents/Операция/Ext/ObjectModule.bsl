
Процедура ОбработкаПроведения(Отказ, Режим)
	
	Если ТипОперации = Перечисления.Операции.ПоступлениеСредств Тогда
		ВидДвижения = ВидДвиженияНакопления.Приход;
	ИначеЕсли ТипОперации = Перечисления.Операции.РасходСредств Тогда
		ВидДвижения = ВидДвиженияНакопления.Расход;
	ИначеЕсли ТипОперации = Перечисления.Операции.СведениеКОстатку Тогда
		Если Сумма > 0 Тогда
			ВидДвижения = ВидДвиженияНакопления.Приход;
		Иначе
			ВидДвижения = ВидДвиженияНакопления.Расход;
			Сумма = -Сумма;
		КонецЕсли; 
	КонецЕсли; 
	
	Движения.Средства.Записывать = Истина;
	Движение = Движения.Средства.Добавить();
	ЗаполнитьЗначенияСвойств(Движение, ЭтотОбъект);
	Движение.ВидДвижения = ВидДвижения;
	Движение.Период = Дата;
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если РежимЗаписи = РежимЗаписиДокумента.Проведение И ТипОперации = Перечисления.Операции.РасходСредств Тогда
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
		Запрос.УстановитьПараметр("ВидСредств", ВидСредств);
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	СредстваОстатки.СуммаОстаток КАК СуммаОстаток
		|ИЗ
		|	РегистрНакопления.Средства.Остатки(&МоментВремени, ВидСредств = &ВидСредств) КАК СредстваОстатки";
		
		РезультатЗапроса = Запрос.Выполнить();
		
		Если РезультатЗапроса.Пустой() Тогда
			Остаток = 0;
		Иначе
			Выборка = РезультатЗапроса.Выбрать();
			Выборка.Следующий();
			Остаток = Выборка.СуммаОстаток;
		КонецЕсли; 
		
		Если Сумма > Остаток Тогда
			Отказ = Истина;
			Сообщить("Недостаточно средств! Остаток = " + Остаток);
		КонецЕсли; 
		
	КонецЕсли;
	 
КонецПроцедуры
